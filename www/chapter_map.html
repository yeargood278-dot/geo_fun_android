<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä½œæˆ˜åœ°å›¾</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { 
            background: #f8f9fa; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }
        
        .navbar { 
            z-index: 10; 
            flex-shrink: 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 10px;
            background: #fff;
        }
        
        .map-viewport { 
            flex: 1; 
            overflow: auto; 
            display: flex; 
            justify-content: center; 
            padding: 20px; 
            background-image: radial-gradient(#dee2e6 1px, transparent 1px); 
            background-size: 20px 20px; 
            -webkit-overflow-scrolling: touch; 
        }

        .nav-btn-group {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 2px;
        }
        .nav-btn-group::-webkit-scrollbar { display: none; }
        .nav-btn-group a { margin-left: 5px; }

        .error-box {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            max-width: 90%;
            word-break: break-all; /* é˜²æ­¢é•¿é”™è¯¯ä¿¡æ¯æ’‘ç ´å¸ƒå±€ */
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-light bg-white px-2 justify-content-between">
        <div class="d-flex align-items-center">
            <a href="index.html" class="btn btn-outline-secondary btn-sm rounded-pill me-2">ğŸ </a>
            <span class="navbar-brand fw-bold fs-6 text-truncate mb-0" id="currentTitle">åŠ è½½ä¸­...</span>
        </div>
        
        <div class="nav-btn-group">
            <a href="chapter_map.html?bid=b1" class="btn btn-sm btn-outline-primary rounded-pill">å¿…1</a>
            <a href="chapter_map.html?bid=b2" class="btn btn-sm btn-outline-warning rounded-pill">å¿…2</a>
            <a href="chapter_map.html?bid=xb1" class="btn btn-sm btn-outline-success rounded-pill">é€‰1</a>
            <a href="chapter_map.html?bid=xb2" class="btn btn-sm btn-outline-secondary rounded-pill" style="color:#9b59b6;border-color:#9b59b6;">é€‰2</a>
            <a href="chapter_map.html?bid=xb3" class="btn btn-sm btn-outline-danger rounded-pill">é€‰3</a>
        </div>
    </nav>

    <div class="map-viewport">
        <div id="mindmapContainer"></div>
    </div>

    <script src="data_zoo.js"></script> 

    <script>
        if (!Object.hasOwn) {
            Object.hasOwn = function(obj, prop) {
                return Object.prototype.hasOwnProperty.call(obj, prop);
            };
        }
    </script>

    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

        function getUrlParam(name) {
            const reg = new RegExp(`(^|&)${name}=([^&]*)(&|$)`);
            const r = window.location.search.substr(1).match(reg);
            return r ? unescape(r[2]) : null;
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const bid = getUrlParam('bid') || 'b1';
            
            // æ•°æ®æºæ£€æŸ¥
            if (typeof books === 'undefined' || typeof mindmaps === 'undefined') {
                document.getElementById('mindmapContainer').innerHTML = 
                    '<div class="error-box">æ•°æ®åŠ è½½å¤±è´¥ï¼è¯·æ£€æŸ¥ data_zoo.js æ–‡ä»¶ã€‚</div>';
                return;
            }

            const currentBook = books[bid];
            if (!currentBook) {
                window.location.href = 'chapter_map.html?bid=b1';
                return;
            }

            document.title = `ä½œæˆ˜åœ°å›¾ - ${currentBook.title}`;
            document.getElementById('currentTitle').textContent = currentBook.title;

            const mapCode = mindmaps[bid];
            const container = document.getElementById('mindmapContainer');

            if (!mapCode) {
                container.innerHTML = '<div class="alert alert-warning">æš‚æ— æ•°æ®</div>';
                return;
            }

            try {
                mermaid.initialize({ 
                    startOnLoad: false, 
                    theme: 'base',
                    securityLevel: 'loose',
                    flowchart: { 
                        useMaxWidth: false, 
                        htmlLabels: true,
                        curve: 'basis'
                    }
                });

                const graphId = 'graph-' + new Date().getTime();
                
                // å°è¯•æ¸²æŸ“
                const { svg } = await mermaid.render(graphId, mapCode);
                container.innerHTML = svg;

            } catch (error) {
                console.error('Mermaid æ¸²æŸ“é”™è¯¯:', error);
                container.innerHTML = `
                    <div class="error-box">
                        <strong>åœ°å›¾æ¸²æŸ“å¤±è´¥</strong><br>
                        <small>${error.message}</small><br>
                        <small class="text-muted">ID: ${bid}</small>
                    </div>`;
            }
        });
    </script>
</body>
</html>